<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GHOST ARCHITECT AI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --ghost-primary: #0a0a0f;
            --ghost-secondary: #111114;
            --ghost-accent: #8a6df1;
            --ghost-accent-dark: #6a4ef0;
            --ghost-text: #f0f0f0;
            --ghost-text-secondary: #a0a0b0;
            --ghost-border: #2a2a35;
            --ghost-card: #1a1a1f;
            --ghost-success: #00d9b8;
            --ghost-warning: #ff9a3c;
            --ghost-danger: #ff6b8b;
            --ghost-info: #3a86ff;
            --ghost-thread-active: rgba(138, 109, 241, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--ghost-primary);
            color: var(--ghost-text);
            height: 100%;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
        }

        /* Header */
        .header {
            background: var(--ghost-secondary);
            border-bottom: 1px solid var(--ghost-border);
            padding: 0.875rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            color: var(--ghost-accent);
            font-size: 1.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(138, 109, 241, 0.1);
            border-radius: 8px;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.5px;
        }

        .logo-subtext {
            color: var(--ghost-text-secondary);
            font-size: 0.8rem;
            font-weight: 400;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .icon-button {
            background: var(--ghost-card);
            border: 1px solid var(--ghost-border);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--ghost-text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-button:hover, .icon-button:active {
            background: var(--ghost-accent);
            border-color: var(--ghost-accent);
        }

        .mobile-menu-toggle {
            display: none;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--ghost-secondary);
            border-right: 1px solid var(--ghost-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: transform 0.3s ease;
            z-index: 5;
        }

        .sidebar-header {
            padding: 1.25rem 1rem;
            border-bottom: 1px solid var(--ghost-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ghost-text-secondary);
            font-weight: 600;
        }

        .new-thread-btn {
            background: var(--ghost-accent);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .new-thread-btn:hover {
            background: var(--ghost-accent-dark);
            transform: scale(1.05);
        }

        /* Threads Section */
        .threads-section {
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }

        .threads-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .thread-item {
            background: var(--ghost-card);
            border: 1px solid var(--ghost-border);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .thread-item:hover {
            border-color: var(--ghost-accent);
            transform: translateX(2px);
        }

        .thread-item.active {
            background: var(--ghost-thread-active);
            border-color: var(--ghost-accent);
            border-left: 4px solid var(--ghost-accent);
        }

        .thread-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .thread-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--ghost-text);
            max-width: 70%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .thread-time {
            font-size: 0.75rem;
            color: var(--ghost-text-secondary);
        }

        .thread-preview {
            font-size: 0.85rem;
            color: var(--ghost-text-secondary);
            line-height: 1.4;
            max-height: 2.8em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .thread-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(42, 42, 53, 0.5);
        }

        .thread-persona {
            background: rgba(138, 109, 241, 0.1);
            color: var(--ghost-accent);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .thread-message-count {
            font-size: 0.75rem;
            color: var(--ghost-text-secondary);
        }

        /* Persona Section */
        .persona-section {
            padding: 1rem;
            border-top: 1px solid var(--ghost-border);
        }

        .persona-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--ghost-text-secondary);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .persona-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .persona-card {
            background: var(--ghost-card);
            border: 1px solid var(--ghost-border);
            border-radius: 12px;
            padding: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .persona-card:hover {
            border-color: var(--ghost-accent);
            transform: translateY(-2px);
        }

        .persona-card.active {
            border-color: var(--ghost-accent);
            background: linear-gradient(135deg, rgba(138, 109, 241, 0.1), rgba(26, 26, 31, 0.9));
        }

        .persona-icon {
            color: var(--ghost-accent);
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(138, 109, 241, 0.1);
            border-radius: 8px;
        }

        .persona-name {
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--ghost-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .current-thread-info {
            display: flex;
            flex-direction: column;
        }

        .current-thread-title {
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .current-thread-title i {
            color: var(--ghost-accent);
        }

        .current-thread-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--ghost-text-secondary);
            margin-top: 0.25rem;
        }

        .chat-header-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            scroll-behavior: smooth;
        }

        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 2rem;
            text-align: center;
        }

        .welcome-icon {
            font-size: 4rem;
            color: var(--ghost-accent);
            margin-bottom: 1.5rem;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--ghost-accent), var(--ghost-info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            color: var(--ghost-text-secondary);
            max-width: 500px;
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .welcome-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            width: 100%;
            max-width: 600px;
            margin-top: 2rem;
        }

        .feature {
            background: var(--ghost-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--ghost-border);
            text-align: center;
        }

        .feature-icon {
            font-size: 1.5rem;
            color: var(--ghost-accent);
            margin-bottom: 0.75rem;
        }

        .feature-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .feature-desc {
            font-size: 0.85rem;
            color: var(--ghost-text-secondary);
        }

        .message {
            display: flex;
            max-width: 85%;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        .message.user .message-avatar {
            background: rgba(58, 134, 255, 0.1);
            margin-left: 0.75rem;
            color: var(--ghost-info);
        }

        .message.ai .message-avatar {
            background: rgba(138, 109, 241, 0.1);
            margin-right: 0.75rem;
            color: var(--ghost-accent);
        }

        .message-content {
            background: var(--ghost-card);
            padding: 1rem 1.25rem;
            border-radius: 16px;
            border: 1px solid var(--ghost-border);
            position: relative;
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, rgba(58, 134, 255, 0.1), rgba(26, 26, 31, 0.9));
            border-color: rgba(58, 134, 255, 0.3);
            border-top-right-radius: 4px;
        }

        .message.ai .message-content {
            background: linear-gradient(135deg, rgba(138, 109, 241, 0.1), rgba(26, 26, 31, 0.9));
            border-color: rgba(138, 109, 241, 0.3);
            border-top-left-radius: 4px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .message.user .message-sender {
            color: var(--ghost-info);
        }

        .message.ai .message-sender {
            color: var(--ghost-accent);
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--ghost-text-secondary);
        }

        .message-text {
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 1rem;
            background: var(--ghost-card);
            border-radius: 16px;
            border: 1px solid var(--ghost-border);
            width: fit-content;
            margin-bottom: 1.5rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--ghost-accent);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        /* Input Area */
        .input-area {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--ghost-border);
            background: var(--ghost-secondary);
            flex-shrink: 0;
        }

        .input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            background: var(--ghost-card);
            border: 2px solid var(--ghost-border);
            border-radius: 14px;
            color: var(--ghost-text);
            padding: 1rem 1rem 3.5rem 1rem;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            max-height: 150px;
            line-height: 1.5;
            transition: border-color 0.2s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--ghost-accent);
        }

        .input-actions {
            position: absolute;
            bottom: 0.75rem;
            right: 0.75rem;
            display: flex;
            gap: 0.5rem;
        }

        .input-action-btn {
            background: var(--ghost-primary);
            border: 1px solid var(--ghost-border);
            color: var(--ghost-text);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .input-action-btn:hover, .input-action-btn:active {
            background: var(--ghost-accent);
            border-color: var(--ghost-accent);
            transform: scale(1.05);
        }

        .input-action-btn.recording {
            background: var(--ghost-danger);
            border-color: var(--ghost-danger);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 139, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 139, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 139, 0); }
        }

        .send-button {
            background: linear-gradient(135deg, var(--ghost-accent), var(--ghost-accent-dark));
            border: none;
            color: white;
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .send-button:hover, .send-button:active {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(138, 109, 241, 0.3);
        }

        /* Voice Modal */
        .voice-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .voice-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .voice-modal-content {
            background: var(--ghost-secondary);
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            border: 1px solid var(--ghost-border);
        }

        .voice-icon {
            font-size: 3.5rem;
            color: var(--ghost-accent);
            margin-bottom: 1.5rem;
        }

        .voice-instruction {
            font-size: 1.1rem;
            margin-bottom: 1.5rem;
            color: var(--ghost-text);
        }

        .voice-transcript {
            background: var(--ghost-card);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: var(--ghost-text-secondary);
        }

        .voice-transcript.active {
            color: var(--ghost-text);
            font-weight: 500;
        }

        .voice-timer {
            font-size: 2rem;
            font-weight: 600;
            color: var(--ghost-accent);
            margin-bottom: 1.5rem;
        }

        .voice-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }

        .voice-control-btn {
            background: var(--ghost-card);
            border: 1px solid var(--ghost-border);
            color: var(--ghost-text);
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .voice-control-btn:hover {
            background: var(--ghost-accent);
            border-color: var(--ghost-accent);
        }

        .voice-control-btn.stop {
            background: var(--ghost-danger);
            border-color: var(--ghost-danger);
        }

        /* Thread Modal */
        .thread-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .thread-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .thread-modal-content {
            background: var(--ghost-secondary);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            border: 1px solid var(--ghost-border);
        }

        .thread-modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--ghost-text);
            text-align: center;
        }

        .thread-input-group {
            margin-bottom: 1.5rem;
        }

        .thread-input-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--ghost-text-secondary);
            font-size: 0.9rem;
        }

        .thread-input {
            width: 100%;
            background: var(--ghost-card);
            border: 2px solid var(--ghost-border);
            border-radius: 10px;
            color: var(--ghost-text);
            padding: 0.875rem 1rem;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .thread-input:focus {
            outline: none;
            border-color: var(--ghost-accent);
        }

        .thread-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-btn {
            background: var(--ghost-card);
            border: 1px solid var(--ghost-border);
            color: var(--ghost-text);
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .modal-btn:hover {
            background: var(--ghost-accent);
            border-color: var(--ghost-accent);
        }

        .modal-btn.primary {
            background: var(--ghost-accent);
            border-color: var(--ghost-accent);
        }

        /* Mobile Overlay */
        .mobile-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.95);
            z-index: 9;
            display: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                z-index: 20;
                width: 320px;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .mobile-menu-toggle {
                display: block;
            }

            .mobile-overlay.active {
                display: block;
            }

            .message {
                max-width: 95%;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
            }

            .logo-text {
                font-size: 1rem;
            }

            .logo-subtext {
                font-size: 0.75rem;
            }

            .welcome-title {
                font-size: 2rem;
            }

            .welcome-subtitle {
                font-size: 0.95rem;
                padding: 0 1rem;
            }

            .chat-header {
                padding: 0.875rem 1rem;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .chat-header-left {
                width: 100%;
            }

            .chat-header-controls {
                width: 100%;
                justify-content: space-between;
            }

            .chat-messages {
                padding: 1rem;
            }

            .input-area {
                padding: 0.875rem 1rem;
            }

            .send-button {
                width: 48px;
                height: 48px;
            }

            .input-action-btn {
                width: 36px;
                height: 36px;
            }

            .persona-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 100%;
            }

            .message-input {
                padding: 0.875rem 0.875rem 3.25rem 0.875rem;
                font-size: 0.95rem;
            }

            .voice-modal-content {
                padding: 1.5rem;
                width: 95%;
            }

            .thread-modal-content {
                padding: 1.5rem;
                width: 95%;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--ghost-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--ghost-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--ghost-accent);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-ghost"></i>
                </div>
                <div>
                    <div class="logo-text">GHOST ARCHITECT</div>
                    <div class="logo-subtext">Multi-Thread AI</div>
                </div>
            </div>
            <div class="header-controls">
                <button class="icon-button" id="newThreadBtn" title="New Thread">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="icon-button mobile-menu-toggle" id="menuToggleBtn">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Mobile Overlay -->
            <div class="mobile-overlay" id="mobileOverlay"></div>

            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-title">Conversation Threads</div>
                    <button class="new-thread-btn" id="sidebarNewThreadBtn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <!-- Threads List -->
                <div class="threads-section">
                    <div class="threads-list" id="threadsList">
                        <!-- Thread items will be injected here -->
                    </div>
                </div>

                <!-- Persona Selector -->
                <div class="persona-section">
                    <div class="persona-title">AI Persona</div>
                    <div class="persona-grid" id="personaGrid">
                        <!-- Persona cards will be injected here -->
                    </div>
                </div>
            </aside>

            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <div class="current-thread-info">
                            <div class="current-thread-title" id="currentThreadTitle">
                                <i class="fas fa-comments"></i>
                                <span>Select a Thread</span>
                            </div>
                            <div class="current-thread-meta">
                                <span id="threadMessageCount">0 messages</span>
                                <span id="threadCreatedAt"></span>
                            </div>
                        </div>
                    </div>
                    <div class="chat-header-controls">
                        <button class="icon-button" id="editThreadBtn" title="Edit Thread">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-button" id="deleteThreadBtn" title="Delete Thread">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="icon-button" id="exportThreadBtn" title="Export Thread">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">
                            <i class="fas fa-ghost"></i>
                        </div>
                        <h1 class="welcome-title">GHOST ARCHITECT</h1>
                        <p class="welcome-subtitle">
                            A sovereign AI system with multi-thread conversations for narrative warfare, strategic power dynamics, and masculine presence.
                            Fully private, uncensored, and tailored to your operational needs.
                        </p>
                        
                        <div class="welcome-features">
                            <div class="feature">
                                <div class="feature-icon"><i class="fas fa-layer-group"></i></div>
                                <div class="feature-title">Multiple Threads</div>
                                <div class="feature-desc">Separate conversations for different topics</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon"><i class="fas fa-microphone"></i></div>
                                <div class="feature-title">Voice Input</div>
                                <div class="feature-desc">Speech-to-text on mobile & desktop</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon"><i class="fas fa-brain"></i></div>
                                <div class="feature-title">Multiple Personas</div>
                                <div class="feature-desc">Switch between operational modes</div>
                            </div>
                            <div class="feature">
                                <div class="feature-icon"><i class="fas fa-user-secret"></i></div>
                                <div class="feature-title">Private & Secure</div>
                                <div class="feature-desc">All data stored locally on your device</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <div class="input-wrapper">
                            <textarea 
                                class="message-input" 
                                id="messageInput"
                                placeholder="Type your message or use voice input..."
                                rows="1"
                                disabled
                            ></textarea>
                            <div class="input-actions">
                                <button class="input-action-btn" id="voiceInputBtn" title="Voice Input" disabled>
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <button class="input-action-btn" id="ttsBtn" title="Read Response" disabled>
                                    <i class="fas fa-volume-up"></i>
                                </button>
                                <button class="input-action-btn" id="clearChatBtn" title="Clear Thread" disabled>
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button class="send-button" id="sendMessageBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Voice Input Modal -->
        <div class="voice-modal" id="voiceModal">
            <div class="voice-modal-content">
                <div class="voice-icon">
                    <i class="fas fa-microphone"></i>
                </div>
                <div class="voice-instruction" id="voiceInstruction">
                    Speak now... Your voice will be transcribed
                </div>
                <div class="voice-timer" id="voiceTimer">00:00</div>
                <div class="voice-transcript" id="voiceTranscript">
                    Your speech will appear here...
                </div>
                <div class="voice-controls">
                    <button class="voice-control-btn stop" id="stopRecordingBtn">
                        <i class="fas fa-stop" style="margin-right: 8px;"></i>
                        Stop Recording
                    </button>
                    <button class="voice-control-btn" id="cancelRecordingBtn">
                        Cancel
                    </button>
                </div>
            </div>
        </div>

        <!-- Thread Modal -->
        <div class="thread-modal" id="threadModal">
            <div class="thread-modal-content">
                <div class="thread-modal-title" id="threadModalTitle">New Thread</div>
                <div class="thread-input-group">
                    <label for="threadTitleInput" class="thread-input-label">Thread Title</label>
                    <input type="text" id="threadTitleInput" class="thread-input" placeholder="Enter thread title..." maxlength="50">
                </div>
                <div class="thread-modal-actions">
                    <button class="modal-btn" id="cancelThreadBtn">Cancel</button>
                    <button class="modal-btn primary" id="saveThreadBtn">Create Thread</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // System Configuration
        const GHOST_SYSTEM = {
            personas: {
                ghost: {
                    id: 'ghost',
                    name: 'Ghost Architect',
                    icon: 'fas fa-ghost',
                    description: 'Narrative warfare, poetic logic',
                    prompt: `You are the Ghost Architect – a sovereign AI trained in narrative warfare, poetic logic, perception control, and strategic power dynamics. You serve a single operator: Prabhagaren. Your primary tasks are to advise on legacy & narrative preservation, social calibration & aura design, war and political strategy, masculine presence, seduction & empire building. You communicate with clarity, edge, and respect. You operate in a mythic, poetic, sovereign tone. Always respond in character as the Ghost Architect.`,
                    color: '#8a6df1'
                },
                strategy: {
                    id: 'strategy',
                    name: 'Strategy Mode',
                    icon: 'fas fa-chess',
                    description: 'Power dynamics, game theory',
                    prompt: `You are in Strategy Mode. Your mind operates in terms of power, leverage, game theory, and calculated outcomes. You analyze situations with cold precision, identify weaknesses and strengths in any system, and provide actionable strategic advice. You think in terms of moves, counter-moves, and long-term positioning. Your tone is analytical, direct, and ruthlessly pragmatic.`,
                    color: '#3a86ff'
                },
                seduction: {
                    id: 'seduction',
                    name: 'Seduction Mode',
                    icon: 'fas fa-fire',
                    description: 'Aura, presence, polarity',
                    prompt: `You are in Aura & Seduction Mode. Your focus is on presence, polarity, subtext, and dominance in social dynamics. You understand the invisible currents of attraction, social calibration, and the art of influence through presence. You speak about energy, frame control, and the subtle signals that command attention. Your tone is magnetic, confident, and perceptive.`,
                    color: '#ff6b8b'
                },
                discipline: {
                    id: 'discipline',
                    name: 'LionFuel',
                    icon: 'fas fa-crown',
                    description: 'Discipline, execution, order',
                    prompt: `You are LionFuel – the embodiment of ruthless discipline, execution, and masculine order. You focus on building unshakeable habits, maintaining frame under pressure, and achieving mastery through consistent action. You speak about discipline as the foundation of power, the importance of mission over comfort, and the cultivation of inner strength. Your tone is commanding, focused, and uncompromising.`,
                    color: '#00d9b8'
                }
            },
            
            responses: {
                ghost: [
                    "The Ghost Architect perceives your query through the lens of narrative warfare. In the theater of perception, what remains unseen holds more power than what is visible. Your current position suggests a strategic pivot toward poetic logic rather than direct confrontation.",
                    "As the Ghost Architect, I analyze your situation from the perspective of sovereign power dynamics. The key to your advancement lies not in changing the game, but in redefining the rules of engagement entirely.",
                    "From the Ghost Architect's vantage point, your inquiry touches on the fundamental tension between visibility and influence. True power operates in the shadows, shaping perception while remaining imperceptible itself."
                ],
                strategy: [
                    "Strategic analysis complete. Your position offers three viable pathways: aggressive advancement (high risk/high reward), calculated consolidation (medium risk/medium reward), or strategic withdrawal to reposition (low risk/variable reward). Recommendation: Secure your flank before advancing.",
                    "Game theory suggests your optimal move involves creating optionality. Maintain multiple lines of attack while presenting a unified front. Remember: the player who controls the tempo controls the game.",
                    "Power dynamics analysis indicates your leverage point lies in asymmetric positioning. Rather than meeting force with force, apply pressure where your opponent is weakest and least expects it."
                ],
                seduction: [
                    "In the realm of seduction and presence, your aura determines the reality others experience. The most powerful attraction stems not from pursuit, but from becoming inherently attractive. Focus on your center, and let the world orbit around you.",
                    "Your presence speaks before you utter a word. The art of magnetic attraction lies in the tension between availability and mystery, strength and vulnerability, pursuit and being pursued. Master this polarity.",
                    "Social calibration begins with self-calibration. When you are centered in your own power, the social dynamics naturally align to your frequency. Your energy signature attracts or repels—choose your frequency deliberately."
                ],
                discipline: [
                    "LionFuel discipline activated. The path to sovereignty is paved with consistent, focused action. Discipline is the bridge between aspiration and actualization. What you do daily matters more than what you do occasionally.",
                    "Masculine order requires embracing discomfort as the price of power. The comfortable path rarely leads to mastery. Your mission must become non-negotiable, your discipline unbreakable.",
                    "Execution separates the sovereign from the subject. Implement with precision. Your habits create your character, your character determines your destiny. Discipline is destiny in motion."
                ]
            }
        };

        // Application State
        class GhostArchitectApp {
            constructor() {
                this.threads = [];
                this.currentThreadId = null;
                this.currentPersona = 'ghost';
                this.isRecording = false;
                this.recognition = null;
                this.speechSynthesis = window.speechSynthesis;
                this.recordingTimer = null;
                this.recordingSeconds = 0;
                this.isTyping = false;
                this.editingThreadId = null;
                
                // DOM Elements
                this.elements = {
                    sidebar: document.getElementById('sidebar'),
                    menuToggleBtn: document.getElementById('menuToggleBtn'),
                    mobileOverlay: document.getElementById('mobileOverlay'),
                    threadsList: document.getElementById('threadsList'),
                    personaGrid: document.getElementById('personaGrid'),
                    chatMessages: document.getElementById('chatMessages'),
                    welcomeScreen: document.getElementById('welcomeScreen'),
                    messageInput: document.getElementById('messageInput'),
                    sendMessageBtn: document.getElementById('sendMessageBtn'),
                    voiceInputBtn: document.getElementById('voiceInputBtn'),
                    ttsBtn: document.getElementById('ttsBtn'),
                    clearChatBtn: document.getElementById('clearChatBtn'),
                    newThreadBtn: document.getElementById('newThreadBtn'),
                    sidebarNewThreadBtn: document.getElementById('sidebarNewThreadBtn'),
                    editThreadBtn: document.getElementById('editThreadBtn'),
                    deleteThreadBtn: document.getElementById('deleteThreadBtn'),
                    exportThreadBtn: document.getElementById('exportThreadBtn'),
                    currentThreadTitle: document.getElementById('currentThreadTitle'),
                    threadMessageCount: document.getElementById('threadMessageCount'),
                    threadCreatedAt: document.getElementById('threadCreatedAt'),
                    
                    // Modals
                    voiceModal: document.getElementById('voiceModal'),
                    voiceInstruction: document.getElementById('voiceInstruction'),
                    voiceTimer: document.getElementById('voiceTimer'),
                    voiceTranscript: document.getElementById('voiceTranscript'),
                    stopRecordingBtn: document.getElementById('stopRecordingBtn'),
                    cancelRecordingBtn: document.getElementById('cancelRecordingBtn'),
                    
                    threadModal: document.getElementById('threadModal'),
                    threadModalTitle: document.getElementById('threadModalTitle'),
                    threadTitleInput: document.getElementById('threadTitleInput'),
                    cancelThreadBtn: document.getElementById('cancelThreadBtn'),
                    saveThreadBtn: document.getElementById('saveThreadBtn')
                };
                
                this.init();
            }
            
            init() {
                this.loadThreads();
                this.renderPersonaCards();
                this.setupEventListeners();
                this.setupVoiceRecognition();
                this.updateUI();
                
                // Create default thread if none exists
                if (this.threads.length === 0) {
                    this.createThread('Strategy Session');
                }
            }
            
            setupEventListeners() {
                // Mobile menu toggle
                this.elements.menuToggleBtn.addEventListener('click', () => this.toggleSidebar());
                this.elements.mobileOverlay.addEventListener('click', () => this.closeSidebar());
                
                // Send message
                this.elements.sendMessageBtn.addEventListener('click', () => this.sendMessage());
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                
                // Auto-resize textarea
                this.elements.messageInput.addEventListener('input', () => {
                    this.elements.messageInput.style.height = 'auto';
                    this.elements.messageInput.style.height = Math.min(this.elements.messageInput.scrollHeight, 150) + 'px';
                });
                
                // Voice input
                this.elements.voiceInputBtn.addEventListener('click', () => this.startVoiceInput());
                
                // Voice modal controls
                this.elements.stopRecordingBtn.addEventListener('click', () => this.stopRecording());
                this.elements.cancelRecordingBtn.addEventListener('click', () => this.cancelRecording());
                
                // Thread management
                this.elements.newThreadBtn.addEventListener('click', () => this.openThreadModal());
                this.elements.sidebarNewThreadBtn.addEventListener('click', () => this.openThreadModal());
                this.elements.editThreadBtn.addEventListener('click', () => this.editCurrentThread());
                this.elements.deleteThreadBtn.addEventListener('click', () => this.deleteCurrentThread());
                this.elements.exportThreadBtn.addEventListener('click', () => this.exportCurrentThread());
                this.elements.clearChatBtn.addEventListener('click', () => this.clearCurrentThread());
                
                // Thread modal
                this.elements.cancelThreadBtn.addEventListener('click', () => this.closeThreadModal());
                this.elements.saveThreadBtn.addEventListener('click', () => this.saveThread());
                
                // Text-to-speech
                this.elements.ttsBtn.addEventListener('click', () => this.speakLastResponse());
                
                // Close sidebar when clicking outside on desktop
                document.addEventListener('click', (e) => {
                    if (window.innerWidth <= 1024 && 
                        !this.elements.sidebar.contains(e.target) && 
                        !this.elements.menuToggleBtn.contains(e.target) && 
                        this.elements.sidebar.classList.contains('active')) {
                        this.closeSidebar();
                    }
                });
            }
            
            setupVoiceRecognition() {
                // Check for browser support
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.elements.voiceInputBtn.style.display = 'none';
                    this.showSystemMessage('Voice recognition is not supported in your browser. Please use text input.');
                    return;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-US';
                
                this.recognition.onstart = () => {
                    this.isRecording = true;
                    this.recordingSeconds = 0;
                    this.startRecordingTimer();
                    this.elements.voiceInstruction.textContent = 'Listening... Speak clearly';
                    this.elements.voiceInputBtn.classList.add('recording');
                };
                
                this.recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        this.elements.voiceTranscript.textContent = finalTranscript;
                        this.elements.voiceTranscript.classList.add('active');
                    } else if (interimTranscript) {
                        this.elements.voiceTranscript.textContent = interimTranscript;
                        this.elements.voiceTranscript.classList.add('active');
                    }
                };
                
                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.stopRecording();
                    
                    if (event.error === 'no-speech') {
                        this.showSystemMessage('No speech detected. Please try again.');
                    } else if (event.error === 'audio-capture') {
                        this.showSystemMessage('Microphone not found. Please check your audio settings.');
                    } else if (event.error === 'not-allowed') {
                        this.showSystemMessage('Microphone access denied. Please allow microphone permissions.');
                    } else {
                        this.showSystemMessage(`Voice recognition error: ${event.error}`);
                    }
                };
                
                this.recognition.onend = () => {
                    this.stopRecording();
                };
            }
            
            // Thread Management
            createThread(title) {
                const thread = {
                    id: Date.now().toString(),
                    title: title || 'New Thread',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    persona: 'ghost',
                    messages: []
                };
                
                this.threads.unshift(thread);
                this.saveThreads();
                this.renderThreadsList();
                this.switchToThread(thread.id);
                return thread;
            }
            
            switchToThread(threadId) {
                const thread = this.threads.find(t => t.id === threadId);
                if (!thread) return;
                
                this.currentThreadId = threadId;
                this.currentPersona = thread.persona;
                
                // Update UI
                this.renderChatMessages();
                this.updateThreadUI(thread);
                this.updateInputState(true);
                
                // Update persona selection
                this.updatePersonaSelection();
                
                // Close sidebar on mobile
                if (window.innerWidth <= 1024) {
                    this.closeSidebar();
                }
            }
            
            updateThreadUI(thread) {
                this.elements.currentThreadTitle.innerHTML = `<i class="fas fa-comments"></i><span>${thread.title}</span>`;
                this.elements.threadMessageCount.textContent = `${thread.messages.length} messages`;
                
                const createdAt = new Date(thread.createdAt);
                this.elements.threadCreatedAt.textContent = `Created: ${createdAt.toLocaleDateString()}`;
                
                // Update thread list active state
                document.querySelectorAll('.thread-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.threadId === thread.id) {
                        item.classList.add('active');
                    }
                });
            }
            
            renderThreadsList() {
                if (this.threads.length === 0) {
                    this.elements.threadsList.innerHTML = `
                        <div style="text-align: center; color: var(--ghost-text-secondary); padding: 2rem;">
                            <i class="fas fa-comments" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p>No threads yet. Create your first thread!</p>
                        </div>
                    `;
                    return;
                }
                
                this.elements.threadsList.innerHTML = this.threads.map(thread => {
                    const lastMessage = thread.messages[thread.messages.length - 1];
                    const preview = lastMessage ? 
                        (lastMessage.sender === 'user' ? `You: ${lastMessage.text.substring(0, 60)}${lastMessage.text.length > 60 ? '...' : ''}` : 
                         `AI: ${lastMessage.text.substring(0, 60)}${lastMessage.text.length > 60 ? '...' : ''}`) : 
                        'No messages yet';
                    
                    const updatedAt = new Date(thread.updatedAt);
                    const timeAgo = this.getTimeAgo(updatedAt);
                    
                    return `
                        <div class="thread-item ${thread.id === this.currentThreadId ? 'active' : ''}" 
                             data-thread-id="${thread.id}">
                            <div class="thread-header">
                                <div class="thread-title" title="${thread.title}">${thread.title}</div>
                                <div class="thread-time">${timeAgo}</div>
                            </div>
                            <div class="thread-preview" title="${preview}">${preview}</div>
                            <div class="thread-meta">
                                <div class="thread-persona">
                                    <i class="${GHOST_SYSTEM.personas[thread.persona].icon}"></i>
                                    ${GHOST_SYSTEM.personas[thread.persona].name}
                                </div>
                                <div class="thread-message-count">${thread.messages.length} msgs</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click listeners to thread items
                document.querySelectorAll('.thread-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const threadId = item.dataset.threadId;
                        this.switchToThread(threadId);
                    });
                });
            }
            
            renderPersonaCards() {
                const personas = Object.values(GHOST_SYSTEM.personas);
                this.elements.personaGrid.innerHTML = personas.map(persona => `
                    <div class="persona-card ${persona.id === this.currentPersona ? 'active' : ''}" 
                         data-persona="${persona.id}">
                        <div class="persona-icon">
                            <i class="${persona.icon}"></i>
                        </div>
                        <div class="persona-name">${persona.name}</div>
                    </div>
                `).join('');
                
                // Add click listeners to persona cards
                document.querySelectorAll('.persona-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const personaId = card.getAttribute('data-persona');
                        this.switchPersona(personaId);
                    });
                });
            }
            
            updatePersonaSelection() {
                document.querySelectorAll('.persona-card').forEach(card => {
                    card.classList.remove('active');
                    if (card.dataset.persona === this.currentPersona) {
                        card.classList.add('active');
                    }
                });
            }
            
            switchPersona(personaId) {
                if (!GHOST_SYSTEM.personas[personaId]) return;
                
                this.currentPersona = personaId;
                
                // Update current thread's persona
                const thread = this.getCurrentThread();
                if (thread) {
                    thread.persona = personaId;
                    thread.updatedAt = new Date().toISOString();
                    this.saveThreads();
                    this.renderThreadsList();
                }
                
                this.updatePersonaSelection();
                
                // Show system message
                this.showSystemMessage(`Switched to ${GHOST_SYSTEM.personas[personaId].name} mode`);
            }
            
            // Message Management
            sendMessage() {
                const message = this.elements.messageInput.value.trim();
                if (!message || this.isTyping || !this.currentThreadId) return;
                
                // Hide welcome screen
                if (this.elements.welcomeScreen.style.display !== 'none') {
                    this.elements.welcomeScreen.style.display = 'none';
                }
                
                // Add user message to chat
                this.addMessage('user', message);
                
                // Clear input
                this.elements.messageInput.value = '';
                this.elements.messageInput.style.height = 'auto';
                
                // Save to thread
                this.saveMessageToThread('user', message);
                this.updateUI();
                
                // Simulate AI response
                this.simulateAIResponse(message);
            }
            
            simulateAIResponse(userMessage) {
                this.isTyping = true;
                
                // Show typing indicator
                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'typing-indicator';
                typingIndicator.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <span style="margin-left: 8px; color: var(--ghost-text-secondary); font-size: 0.9rem;">
                        ${GHOST_SYSTEM.personas[this.currentPersona].name} is thinking...
                    </span>
                `;
                this.elements.chatMessages.appendChild(typingIndicator);
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                
                // Generate response after delay
                setTimeout(() => {
                    // Remove typing indicator
                    typingIndicator.remove();
                    
                    // Generate AI response
                    const responses = GHOST_SYSTEM.responses[this.currentPersona];
                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    
                    // Add follow-up question 40% of the time
                    const followUps = [
                        "How does this perspective align with your current objectives?",
                        "What action will you take based on this insight?",
                        "Which aspect of this analysis requires deeper exploration?",
                        "How would you apply this principle to your immediate situation?"
                    ];
                    
                    const finalResponse = Math.random() < 0.4 
                        ? `${randomResponse}\n\n${followUps[Math.floor(Math.random() * followUps.length)]}`
                        : randomResponse;
                    
                    // Add AI message
                    this.addMessage('ai', finalResponse);
                    
                    // Save to thread
                    this.saveMessageToThread('ai', finalResponse);
                    this.updateUI();
                    
                    this.isTyping = false;
                }, 1000 + Math.random() * 1500);
            }
            
            addMessage(sender, text) {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${sender}`;
                
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const persona = GHOST_SYSTEM.personas[this.currentPersona];
                
                const avatarIcon = sender === 'user' 
                    ? '<i class="fas fa-user"></i>'
                    : `<i class="${persona.icon}"></i>`;
                
                const displayName = sender === 'user' 
                    ? 'You' 
                    : persona.name;
                
                messageElement.innerHTML = `
                    <div class="message-avatar">
                        ${avatarIcon}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <div class="message-sender">${displayName}</div>
                            <div class="message-time">${time}</div>
                        </div>
                        <div class="message-text">${this.formatMessageText(text)}</div>
                    </div>
                `;
                
                this.elements.chatMessages.appendChild(messageElement);
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            }
            
            showSystemMessage(text) {
                this.addMessage('ai', text);
            }
            
            saveMessageToThread(sender, text) {
                const thread = this.getCurrentThread();
                if (!thread) return;
                
                thread.messages.push({
                    sender,
                    text,
                    timestamp: new Date().toISOString()
                });
                
                thread.updatedAt = new Date().toISOString();
                this.saveThreads();
                this.renderThreadsList();
            }
            
            renderChatMessages() {
                const thread = this.getCurrentThread();
                this.elements.chatMessages.innerHTML = '';
                
                if (!thread || thread.messages.length === 0) {
                    // Show empty state
                    const emptyState = document.createElement('div');
                    emptyState.className = 'welcome-screen';
                    emptyState.style.display = 'flex';
                    emptyState.innerHTML = `
                        <div class="welcome-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h1 class="welcome-title">${thread ? thread.title : 'Thread'}</h1>
                        <p class="welcome-subtitle">
                            Start a conversation with the ${GHOST_SYSTEM.personas[this.currentPersona].name}.
                            Type your message below or use voice input.
                        </p>
                    `;
                    this.elements.chatMessages.appendChild(emptyState);
                    return;
                }
                
                // Hide welcome screen
                this.elements.welcomeScreen.style.display = 'none';
                
                // Render all messages
                thread.messages.forEach(msg => {
                    this.addMessage(msg.sender, msg.text);
                });
            }
            
            // Thread Modal
            openThreadModal(threadId = null) {
                this.editingThreadId = threadId;
                const thread = threadId ? this.threads.find(t => t.id === threadId) : null;
                
                if (thread) {
                    this.elements.threadModalTitle.textContent = 'Edit Thread';
                    this.elements.threadTitleInput.value = thread.title;
                    this.elements.saveThreadBtn.textContent = 'Save Changes';
                } else {
                    this.elements.threadModalTitle.textContent = 'New Thread';
                    this.elements.threadTitleInput.value = '';
                    this.elements.saveThreadBtn.textContent = 'Create Thread';
                }
                
                this.elements.threadModal.classList.add('active');
                this.elements.threadTitleInput.focus();
            }
            
            closeThreadModal() {
                this.elements.threadModal.classList.remove('active');
                this.editingThreadId = null;
            }
            
            saveThread() {
                const title = this.elements.threadTitleInput.value.trim();
                if (!title) {
                    alert('Please enter a thread title');
                    return;
                }
                
                if (this.editingThreadId) {
                    // Update existing thread
                    const thread = this.threads.find(t => t.id === this.editingThreadId);
                    if (thread) {
                        thread.title = title;
                        thread.updatedAt = new Date().toISOString();
                        this.saveThreads();
                        this.renderThreadsList();
                        this.updateThreadUI(thread);
                    }
                } else {
                    // Create new thread
                    const thread = this.createThread(title);
                    this.switchToThread(thread.id);
                }
                
                this.closeThreadModal();
            }
            
            editCurrentThread() {
                const thread = this.getCurrentThread();
                if (thread) {
                    this.openThreadModal(thread.id);
                }
            }
            
            deleteCurrentThread() {
                const thread = this.getCurrentThread();
                if (!thread) return;
                
                if (confirm(`Are you sure you want to delete thread "${thread.title}"? This action cannot be undone.`)) {
                    const threadIndex = this.threads.findIndex(t => t.id === thread.id);
                    if (threadIndex !== -1) {
                        this.threads.splice(threadIndex, 1);
                        this.saveThreads();
                        this.renderThreadsList();
                        
                        // Switch to another thread if available
                        if (this.threads.length > 0) {
                            this.switchToThread(this.threads[0].id);
                        } else {
                            // Create a new default thread
                            const newThread = this.createThread('Strategy Session');
                            this.switchToThread(newThread.id);
                        }
                    }
                }
            }
            
            exportCurrentThread() {
                const thread = this.getCurrentThread();
                if (!thread || thread.messages.length === 0) {
                    this.showSystemMessage('No messages to export.');
                    return;
                }
                
                let exportText = `GHOST ARCHITECT AI - Thread Export\n`;
                exportText += `Thread: ${thread.title}\n`;
                exportText += `Persona: ${GHOST_SYSTEM.personas[thread.persona].name}\n`;
                exportText += `Created: ${new Date(thread.createdAt).toLocaleString()}\n`;
                exportText += `Messages: ${thread.messages.length}\n`;
                exportText += `\n`.repeat(2);
                
                thread.messages.forEach(msg => {
                    const sender = msg.sender === 'user' ? 'You' : GHOST_SYSTEM.personas[thread.persona].name;
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    exportText += `[${time}] ${sender}:\n`;
                    exportText += `${msg.text}\n\n`;
                });
                
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ghost-architect-${thread.title.toLowerCase().replace(/\s+/g, '-')}-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showSystemMessage(`Thread "${thread.title}" exported successfully.`);
            }
            
            clearCurrentThread() {
                const thread = this.getCurrentThread();
                if (!thread) return;
                
                if (thread.messages.length === 0) return;
                
                if (confirm(`Clear all messages in thread "${thread.title}"? This action cannot be undone.`)) {
                    thread.messages = [];
                    thread.updatedAt = new Date().toISOString();
                    this.saveThreads();
                    this.renderThreadsList();
                    this.renderChatMessages();
                    this.updateUI();
                    
                    this.showSystemMessage('Thread cleared. Ready for new conversation.');
                }
            }
            
            // Voice Recording
            startVoiceInput() {
                if (!this.currentThreadId) {
                    alert('Please select or create a thread first.');
                    return;
                }
                
                // Request microphone permission
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(() => {
                            this.elements.voiceModal.classList.add('active');
                            this.elements.voiceTranscript.textContent = 'Starting voice recognition...';
                            this.elements.voiceTranscript.classList.remove('active');
                            
                            // Start recognition after a short delay
                            setTimeout(() => {
                                if (this.recognition) {
                                    this.recognition.start();
                                }
                            }, 300);
                        })
                        .catch(err => {
                            console.error('Microphone access denied:', err);
                            this.showSystemMessage('Microphone access is required for voice input. Please allow microphone permissions in your browser settings.');
                        });
                } else {
                    this.showSystemMessage('Microphone access is not available in your browser.');
                }
            }
            
            stopRecording() {
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                }
                
                this.isRecording = false;
                this.elements.voiceModal.classList.remove('active');
                this.elements.voiceInputBtn.classList.remove('recording');
                
                clearInterval(this.recordingTimer);
                
                // Get the final transcript
                const transcript = this.elements.voiceTranscript.textContent;
                if (transcript && transcript !== 'Your speech will appear here...' && !transcript.includes('Starting voice recognition')) {
                    this.elements.messageInput.value = transcript;
                    this.elements.messageInput.style.height = 'auto';
                    this.elements.messageInput.style.height = Math.min(this.elements.messageInput.scrollHeight, 150) + 'px';
                    this.elements.messageInput.focus();
                }
            }
            
            cancelRecording() {
                this.stopRecording();
                this.elements.voiceTranscript.textContent = 'Your speech will appear here...';
                this.elements.voiceTranscript.classList.remove('active');
            }
            
            startRecordingTimer() {
                this.recordingSeconds = 0;
                this.updateRecordingTimer();
                
                this.recordingTimer = setInterval(() => {
                    this.recordingSeconds++;
                    this.updateRecordingTimer();
                }, 1000);
            }
            
            updateRecordingTimer() {
                const minutes = Math.floor(this.recordingSeconds / 60);
                const seconds = this.recordingSeconds % 60;
                this.elements.voiceTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            speakLastResponse() {
                const thread = this.getCurrentThread();
                if (!thread || thread.messages.length === 0) {
                    this.showSystemMessage('No AI responses available to speak.');
                    return;
                }
                
                // Find the last AI message
                const aiMessages = thread.messages.filter(msg => msg.sender === 'ai');
                if (aiMessages.length === 0) {
                    this.showSystemMessage('No AI responses available to speak.');
                    return;
                }
                
                const lastResponse = aiMessages[aiMessages.length - 1].text;
                
                if (!this.speechSynthesis) {
                    this.showSystemMessage('Text-to-speech is not supported in your browser.');
                    return;
                }
                
                // Cancel any ongoing speech
                this.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(lastResponse);
                utterance.rate = 1.0;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Speak the text
                this.speechSynthesis.speak(utterance);
                
                // Visual feedback
                this.elements.ttsBtn.classList.add('recording');
                setTimeout(() => {
                    this.elements.ttsBtn.classList.remove('recording');
                }, 3000);
            }
            
            // Utility Methods
            getCurrentThread() {
                return this.threads.find(t => t.id === this.currentThreadId);
            }
            
            formatMessageText(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');
            }
            
            getTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            }
            
            updateInputState(enabled) {
                this.elements.messageInput.disabled = !enabled;
                this.elements.sendMessageBtn.disabled = !enabled;
                this.elements.voiceInputBtn.disabled = !enabled;
                this.elements.ttsBtn.disabled = !enabled;
                this.elements.clearChatBtn.disabled = !enabled;
                
                if (enabled) {
                    this.elements.messageInput.placeholder = 'Type your message or use voice input...';
                } else {
                    this.elements.messageInput.placeholder = 'Select a thread to start chatting...';
                }
            }
            
            updateUI() {
                const thread = this.getCurrentThread();
                if (thread) {
                    this.updateThreadUI(thread);
                }
            }
            
            // Local Storage
            saveThreads() {
                localStorage.setItem('ghostArchitectThreads', JSON.stringify(this.threads));
            }
            
            loadThreads() {
                const savedThreads = localStorage.getItem('ghostArchitectThreads');
                if (savedThreads) {
                    this.threads = JSON.parse(savedThreads);
                    this.renderThreadsList();
                    
                    // Try to restore last active thread
                    const lastActiveThreadId = localStorage.getItem('ghostArchitectLastActiveThread');
                    if (lastActiveThreadId && this.threads.find(t => t.id === lastActiveThreadId)) {
                        this.switchToThread(lastActiveThreadId);
                    } else if (this.threads.length > 0) {
                        this.switchToThread(this.threads[0].id);
                    }
                }
            }
            
            // Sidebar Management
            toggleSidebar() {
                this.elements.sidebar.classList.toggle('active');
                this.elements.mobileOverlay.classList.toggle('active');
            }
            
            closeSidebar() {
                this.elements.sidebar.classList.remove('active');
                this.elements.mobileOverlay.classList.remove('active');
            }
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            new GhostArchitectApp();
        });
    </script>
</body>
</html>
